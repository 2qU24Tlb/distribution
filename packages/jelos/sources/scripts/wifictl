#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# Copyright (C) 2020 Fewtarius (https://github.com/fewtarius)

. /etc/profile

COMMAND="$1"
SSID="$(get_setting wifi.ssid)" 2>/dev/null
PSK="$(get_setting wifi.key)" 2>/dev/null
WIFICFG="/storage/.cache/connman/wifi.config"

set_wifi() {
  if [ ! -e "/sys/class/gpio/gpio${DEVICE_WIFI}/direction" ]
  then
    # Enable the GPIO
    echo ${DEVICE_WIFI} > /sys/class/gpio/export 2>/dev/null
  fi
  echo out > /sys/class/gpio/gpio${DEVICE_WIFI}/direction 2>/dev/null

  case "${1}" in
    "enable")
      set_setting wifi.enabled 1
      # Create the WIFI config.
      cat > "${WIFICFG}" <<EOF
[global]
Name=${OS_NAME}

[service_default]
Type=wifi
Name=${SSID}
${PSK}
EOF

      echo 1 > /sys/class/gpio/gpio${DEVICE_WIFI}/value 2>/dev/null
      connmanctl enable wifi 2>/dev/null
      connmanctl scan wifi 2>/dev/null
    ;;
    "disable")
      connmanctl disable wifi 2>/dev/null
      echo 0 > /sys/class/gpio/gpio${DEVICE_WIFI}/value 2>/dev/null
      rm -f "${WIFICFG}" 2>/dev/null
      set_setting wifi.enabled 0
    ;;
    "list")
      connmanctl services | cut -b 5- | sed -e s+'^\([^ ]*\).*$'+'\1'+ | grep -vE '^Wired$|^<hidden>$' 2>/dev/null
    ;;
  esac

  # Disable the GPIO
  echo ${DEVICE_WIFI} > /sys/class/gpio/unexport
}

if [ ! -d "" ]
then
  mkdir -p "/storage/.cache/connman"
fi

set_wifi ${COMMAND}
